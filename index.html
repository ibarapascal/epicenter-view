<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>Earthquake Epicenter Visualization</title>
    <link
      rel="stylesheet"
      href="https://js.arcgis.com/4.15/esri/themes/light/main.css"
    />
    <script src="https://js.arcgis.com/4.15/"></script>
    <style>
      .sidebar {
        height: 100%;
        width: 10%;
        position: fixed;
        top: 0;
        left: 0;
      }
      .sidebar .fieldZone {
        padding: 5%;
      }
      .sidebar .fieldZone p {
        margin: 0px;
      }
      .sidebar hr {
        margin: 0px;
      }
      .applicationDiv {
        margin-left: 10%;
        position: absolute;
        width: 100%;
        height: 100%;
      }
      #timeButton {
        float: right;
      }
      #timeRange {
        width: 100%;
        margin-top: 5%;
        margin-bottom: 5%;
      }
      #viewDiv {
        width: 100%;
        height: 100%;
      }
    </style>
  </head>

  <body>
    <div class="sidebar">
      <div class="fieldZone">
        <h2>Earthquake Epicenter Visualization</h2>
        <p>Author: KeiKai</p>
        <p>Github: <a href="https://github.com/ibarapascal/epicenter-view" alt="">epicenter-view</a></p>
      </div>
      <hr />
      <div class="fieldZone">
        Time
        <button id="timeButton">Run</button>
        <input
          type="range"
          class="slider"
          id="timeRange"
        >
        <p>Pointer: <span id="timePointer"></span></p>
      </div>
      <hr />
      <div class="fieldZone">
        Animation
      </div>
      <hr />
      <div class="fieldZone">
        Note
      </div>
    </div>
    <div class="applicationDiv">
      <div id="viewDiv">
      </div>
    </div>
    <script>
      const timeStart = 1299822360;
      const timeEnd = 1299908760;
      const slider = document.getElementById("timeRange");
      const timePointer = document.getElementById("timePointer");
      const timeButton = document.getElementById("timeButton");
      const timeDiff = timeEnd - timeStart;
      slider.min = timeStart;
      slider.max = timeEnd;
      slider.value = timeStart;
      timePointer.innerHTML = new Date(Number(slider.value) * 1000);

      require([
        "esri/Map",
        "esri/layers/FeatureLayer",
        "esri/views/MapView", // flat
        // "esri/views/SceneView", // earth
        "esri/core/promiseUtils",
        "esri/widgets/Legend",
        "esri/widgets/Home",
        "esri/widgets/Fullscreen",
        "esri/widgets/Slider",
        "esri/widgets/Expand",
        "esri/widgets/BasemapToggle",
      ], function(
        Map,
        FeatureLayer,
        MapView,
        promiseUtils,
        Legend,
        Home,
        Fullscreen,
        Slider,
        Expand,
        BasemapToggle
      ) {
        const renderer = (timestamp) => {
          // https://developers.arcgis.com/javascript/latest/sample-code/visualization-multivariate-2d/index.html
          const colorVisVar = {
            // The type must be set to color for the renderer to know it will use color
            type: "color",
            // Assign the field name to visualize with color
            field: "timestamp",
            // If normalizing set the field to normalize by
            // normalizationField: "magnitude_a",
            // Set the color ramp based on two values (min/max) and two colors
            stops: [
              { value: slider.value - timeDiff, color: [128, 128, 128] },
              { value: slider.value - timeDiff * 0.3, color: [128, 128, 128] },
              { value: slider.value - timeDiff * 0.5, color: [255, 117, 43] },
              { value: slider.value, color: [255, 64, 0] }
            ]
          };
          const sizeVisVar = {
            // The type must be set to size for the renderer to know size will be altered
            type: "size",
            // Assign the field name to visualize with size
            field: "magnitude_a",
            // Set the field to normalize the values by
            // normalizationField: "magnitude_a",
            valueUnit: "unknown",
            // Create a size ramp based on the min/max values
            stops: [
              { value: 1, size: 1 },
              { value: 5, size: 7 },
              { value: 9, size: 49 }
            ]
          };
          // https://developers.arcgis.com/javascript/latest/api-reference/esri-renderers-visualVariables-OpacityVariable.html
          const opacityVisVar = {
            type: "opacity",
            field: "timestamp",
            // maps data values to opacity values
            stops: [
              { value: slider.value - timeDiff * 0.3, opacity: 0.1 },
              { value: slider.value - timeDiff * 0.1, opacity: 0.9 },
              { value: slider.value - 1, opacity: 1 },
              { value: slider.value, opacity: 0 }
            ]
          };
          return {
            type: "simple", // autocasts as new SimpleRenderer()
            // Define a default marker symbol.
            symbol: {
              type: "simple-marker", // autocasts as new SimpleMarkerSymbol()
              outline: {
                color: [192, 192, 192],
                width: 0.5
              }
            }, 
            // Set the color and size visual variables on the renderer
            visualVariables: [colorVisVar, sizeVisVar, opacityVisVar]
          }
        };
        // https://developers.arcgis.com/javascript/latest/api-reference/esri-PopupTemplate.html
        const pTemplate = {
          // autocasts as new PopupTemplate()
          title: "Magnitude: {magnitude_a}",
          // https://developers.arcgis.com/javascript/latest/guide/arcade/
          expressionInfos: [{
            name: "date",
            title: "time",
            expression: "$feature.timestamp * 1000"
          }],
          content: [
            {
              type: "fields", // Autocast as new FieldsContent()
              // https://developers.arcgis.com/javascript/latest/api-reference/esri-popup-support-FieldInfoFormat.html
              fieldInfos: [
                {
                  label: "time",
                  fieldName: "expression/date",
                  format: {
                    places: 0,
                    digitSeparator: false,
                    dateFormat: 'short-date-long-time-24',
                  }
                },
                {
                  label: "latitude",
                  fieldName: "latitude",
                },
                {
                  label: "longitude",
                  fieldName: "longitude",
                },
                {
                  label: "depth",
                  fieldName: "depth",
                },
                {
                  label: "magnitude",
                  fieldName: "magnitude_a",
                }
              ]
            }
          ]
        }
        const layer = new FeatureLayer({
          url: "https://services6.arcgis.com/VvsGqDoDGHhTumpK/arcgis/rest/services/dt_jp_baseattrs_m1_20110311/FeatureServer",
          title: "Epicenter",
          renderer: renderer(Number(slider.value)),
          popupTemplate: pTemplate
        });
        const view = new MapView({
          map: new Map({
            basemap: 'oceans',
            layers: [layer]
          }),
          container: "viewDiv",
          center: [144, 36],
          zoom: 7
        });
        const basemapToggle = new BasemapToggle({
          view: view,
          nextBasemap: "satellite"
        });
        view.ui.add(basemapToggle, "bottom-left");

        let timeout;
        const stopAnimation = () => {
          timeButton.innerText = 'Run';
          clearTimeout(timeout);
        }
        const animationUpdate = t => {
          slider.value = t;
          timePointer.innerHTML = new Date(t * 1000);
          layer.renderer = renderer(t);
        }
        timeButton.addEventListener("click", function() {
          if (timeButton.innerText === 'Run') {
            timeButton.innerText = 'Stop';
            let currentTime = Number(slider.value);
            const displayDuration = 10;
            const framePerSecond = 30;
            const timeDelta = timeDiff / (displayDuration * framePerSecond);
            timeout = setInterval(function() {
              if (currentTime >= timeEnd) {
                stopAnimation();
              }
              animationUpdate(currentTime);
              currentTime += timeDelta;
            }, 1000 / framePerSecond);
          } else {
            stopAnimation();
          }
        });
        slider.oninput = function() {
          stopAnimation();
          animationUpdate(Number(this.value));
        }
      });
    </script>
  </body>
</html>
